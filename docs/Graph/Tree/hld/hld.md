

## **树链剖分思想**

树链剖分的主要思路就是将一棵树，若干条链，让每条链上的 $dfs$ 序是连续的，这样就能将一个树形结构转化为一个线性结构，在处理一条树上路径时，就可以转化为对若干条链进行处理，这就可以用一些线性数据结构来处理，例如线段树。

想要有比较优秀的时间复杂度的话，那么一条路劲上的链就不能太多，应当是像 $\log n$ 或 $\sqrt{n}$ 这样的数量。这就取决于链的划法了。

通常有两种剖分方法，**重链剖分**和**长链剖分**。因为重链剖分通常有更优的复杂度，所以树链剖分一般指的就是重链剖分。


## **重链剖分**

重链剖分的划分思路是这样的：

- 每个节点给的儿子被划分成两部分，**重儿子**和**轻儿子**。重儿子只有一个，表示子节点中子树最大的那个子结点。如果有多个子树最大的子结点，取其一。如果没有子节点，就无重子节点。其余节点都是轻儿子。

- 与重儿子连接的边被称作重边，与轻儿子连接的边被称作轻边。

- 在 $dfs$ 遍历整个树时，每次优先走重儿子，按照这个顺序依次给节点编号，就会将树划分为如下结构：


<figure markdown="span">
  ![Image title](./01.jpg){ width="450" }
</figure>

蓝色框框起来的就是一条重链，图中已将按照上述 $dfs$ 的顺序将节点编号，我们会发现一条链上的编号是连续的，一个子树的编号也是连续的，这样我们就可以将一些树上问题转化为线性的问题。

要将树划成上图这样的结构，需要进行两次 $dfs$，第一次 $dfs$ 计算每个节点的深度和父节点，以及以该节点为根的子树的大小。

```cpp

```

我们来看下面这道模板题：

[P3384 【模板】重链剖分/树链剖分](https://www.luogu.com.cn/problem/P3384){target=_blank}：已知一棵包含 $N$ 个结点的树（连通且无环），每个节点上包含一个数值，需要支持以下操作：

- `1 x y z`，表示将树从 $x$ 到 $y$ 结点最短路径上所有节点的值都加上 $z$。

- `2 x y`，表示求树从 $x$ 到 $y$ 结点最短路径上所有节点的值之和。

- `3 x z`，表示将以 $x$ 为根节点的子树内所有节点值都加上 $z$。

- `4 x` 表示求以 $x$ 为根节点的子树内所有节点值之和





