

## **区间最值操作**

[Gorgeous Sequence](https://acm.hdu.edu.cn/showproblem.php?pid=5306)


有一个长度为$n$ 的序列$a$ 。我们使用$a_i$来表示此序列中的$i -th$ 元素。应对此序列执行以下三种类型的操作。

$0\ \ x\  \ y\  \ t$ ： 对于每个$x≤i≤y$，我们使用$min(a_i,t)$ 来替换原来的 $a_i$的值。

$1\ \ x\ \ y$ ： 打印$a_i$的最大值 $x≤i≤y$ .

$2\  \ x\  \ y$ ： 打印$a_i$ 的总和 $x≤i≤y$ .

线段树解题，解题要用到$Lazy-Tag$标记来实现高效的修改。如何设计标记就是解题的关键。吉如一在其论文中提到的解决方法定义的四个标记，巧妙的将区间最值和区间和结合起来。

对于线段树的每个节点，我们定义四个标记；区间和$sum$、区间最大值$ma$，区间严格次大值$se$，最大值个数$cnt$。

当我们要用$min(a_i,x)$对区间$[l,r]$进行修改时，在线段树上定位到对应区间后，有以下三种情况：
- 当$ma\le x$时，这次修改不影响节点，不进行修改
- 当$se< x<ma$时，这次修改值影响最大值，更新$sum=sum-cnt\times(ma -x)$，并且修改最大值$ma=x$。
- 当$se\ge x$时，无法直接修改这个节点，递归它的左右儿子

上述算法的关键是严格次大值$se$，他起到剪枝的作用。这样看似很暴力的操作，实际复杂度并不是很高，在吉如一的国家队论文中进行详细的证明，其时间复杂度是 $O(m\log n)$ 。